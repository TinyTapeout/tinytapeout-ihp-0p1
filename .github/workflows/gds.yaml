name: gds

on:
  push:
  workflow_dispatch:

jobs:
  gds:
    runs-on: ubuntu-22.04
    env:
      IHP_PDK_ROOT: ${{ github.workspace}}/IHP-Open-PDK
      DESIGN_CONFIG: ${{ github.workspace }}/designs/ihp-sg13g2/tt-chip/config.mk
      DESIGN_HOME: ${{ github.workspace }}/designs
      WORK_HOME: ${{ github.workspace }}

    steps:
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install OpenROAD
        run: |
          wget https://github.com/Precision-Innovations/OpenROAD/releases/download/2024-07-12/openroad_2.0_amd64-ubuntu22.04-2024-07-12.deb
          sudo apt-get install -y ./openroad_2.0_amd64-ubuntu22.04-2024-07-12.deb
          echo "OPENROAD_EXE=$(command -v openroad)" >> $GITHUB_ENV

      - name: Install KLayout
        run: |
          wget https://www.klayout.org/downloads/Ubuntu-22/klayout_0.29.4-1_amd64.deb
          sudo apt-get install -y ./klayout_0.29.4-1_amd64.deb

      - name: 'Install yosys (oss-cad-suite)'
        run: |
          cd /opt
          wget https://github.com/YosysHQ/oss-cad-suite-build/releases/download/2024-07-16/oss-cad-suite-linux-x64-20240716.tgz
          tar zxf oss-cad-suite-linux-x64-20240716.tgz && rm oss-cad-suite-linux-x64-20240716.tgz

      - name: checkout ORFS
        uses: actions/checkout@v4
        with:
          repository: The-OpenROAD-Project/OpenROAD-flow-scripts
          submodules: recursive
          path: 'orfs'

      - name: Run the flow
        working-directory: 'orfs/flow'
        env:
          YOSYS_CMD: /opt/oss-cad-suite/bin/yosys
        run: |
          make

      - name: Upload DRC results
        uses: actions/upload-artifact@v4
        with:
          name: gds
          path: |
            logs
            objects
            reports
            results
